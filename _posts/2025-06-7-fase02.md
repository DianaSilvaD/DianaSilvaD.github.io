---
title: Fase 2 - Emulación de Técnicas 
date: 2025-06-07 00:00:00 -05:00
categories: [apt]
tags: [apt, virtual machine, wizard spider]
---

# Fase 2: Emulación de Técnicas - Wizard Spider

Esta fase consiste en ejecutar técnicas específicas asociadas al adversario Wizard Spider, utilizando binarios conocidos en un entorno controlado para validar detecciones y comportamientos del sistema.

## Entorno de laboratorio

- Host: VirtualBox
- Máquinas virtuales:
  - Kali Linux (Attacker)
  - Windows 10 (ws1, ws2)
  - Windows Server 2019 (dc01)
- Red: Aislada o en modo interno (sin conexión a Internet)
- Herramientas activas:
  - Sysmon
  - Wireshark
  - Procmon
  - Event Viewer

---

## 1. Emulación de PowerShell y servicios

### 1.1. Carpeta Recursos
La carpeta `Resources/` del plan de emulación contiene los componentes para ejecutar técnicas relacionadas con el grupo APT Wizard Spider.

- Archivo comprimido `Binaries.zip`**:
  Incluye todos los ejecutables de forma centralizada para facilitar su descarga y uso.
- La contraseña para todos los archivos `.zip` protegidos es `malware`.

### 1.2. Descifrado automático - KaLinux

Se proporciona un script en Python para automatizar el proceso de descifrado de los ejecutables comprimidos.

```bash
    python3 Resources/Utilities/crypt_executables.py -i ./ -p malware --decrypt
```
- `-i ./` : Directorio de entrada con los archivos ZIP.
- `-p malware` : Contraseña usada para descifrar.
- `--decrypt` : Ejecuta el proceso de desencriptado.

```bash
    root@attacker:~/Descargas/adversary_emulation_library/wizard_spider# python3 Resources/Utilities/crypt_executables.py -i ./ -p malware --decrypt
```

![image.png](/assets/images/2025-05-19-s05/Captura desde 2025-06-07 00-24-43.png)  

![image.png](/assets/images/2025-05-19-s05/Captura desde 2025-06-07 00-27-02.png)  

### 1.3. Acceder vía RDP desde Kali a WS19
Abrir una sesión remota y montar la carpeta local como unidad X: en la sesión de Windows.

- Habilitar RDP en el servidor 10.0.0.4
  - Presiona Win + R, escribe SystemPropertiesRemote.
  - En la pestaña "Remoto", asegúrate de que:
      - La opción "Permitir las conexiones remotas a este equipo" esté marcada.
        ![image.png](/assets/images/2025-06-7-fase02/Captura desde 2025-06-07 16-08-17.png)  

- Conectarse al Domain Controller vía RDP

  ```bash
  xfreerdp +clipboard /u:"oz\\administrator" /p:'$0p0rt3' /v:10.0.0.4 /drive:X,wizard_spider/Resources/setup /cert-ignore
  ```
  ![image.png](/assets/images/2025-06-7-fase02/Captura desde 2025-06-07 16-13-33.png)  

- Unidad compartida X
  ![image.png](/assets/images/2025-06-7-fase02/Captura desde 2025-06-07 16-35-34.png)  


### 1.4. Desactivar Defender y SmartScreen en ws19
Una vez dentro de la sesión de escritorio remoto:

- Abrir Windows Defender:

  - Menú Inicio → Buscar Seguridad de Windows

  - Abrir → “Protección contra virus y amenazas”

  - Desactiva protección en tiempo real, protección basada en la nube, etc.

    ![image.png](/assets/images/2025-06-7-fase02/Captura desde 2025-06-07 16-45-39.png)  


- Desactivar SmartScreen:

  - Menú Inicio → Buscar App y control del navegador

  - Desactivar SmartScreen para apps, Edge y descargas.

    ![image.png](/assets/images/2025-06-7-fase02/Captura desde 2025-06-07 16-50-50.png)  

    ```bash
        # Desactivar SmartScreen para aplicaciones y archivos
        Set-MpPreference -EnableNetworkProtection Disabled

        # Desactivar SmartScreen para Microsoft Edge
        New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer" -Name "SmartScreenEnabled" -PropertyType String -Value "Off" -Force

        # Desactivar SmartScreen para Microsoft Store apps
        New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\AppHost" -Name "EnableWebContentEvaluation" -PropertyType DWord -Value 0 -Force

        # Desactivar protección basada en reputación (Reputation-based protection)
        New-ItemProperty -Path "HKCU:\Software\Microsoft\Windows Defender\SmartScreen" -Name "Enabled" -PropertyType DWord -Value 0 -Force   XXXXX
    ```
    ![image.png](/assets/images/2025-06-7-fase02/Captura desde 2025-06-07 16-53-24.png)  

- Copiar archivos a la carpeta descaargas
  ![image.png](/assets/images/2025-06-7-fase02/Captura desde 2025-06-07 18-19-44.png)  




